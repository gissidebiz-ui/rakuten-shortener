============================= test session starts =============================
platform win32 -- Python 3.12.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\hax37\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\hax37\Documents\yusuke_doc\git\work\rktn
plugins: anyio-4.12.1
collecting ... collected 80 items

tests/test_ai_helpers.py::TestCreateAiClient::test_creates_genai_client PASSED [  1%]
tests/test_ai_helpers.py::TestCreateAiClient::test_returns_client_instance PASSED [  2%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_handles_response_without_text_attribute PASSED [  3%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_logs_metrics_on_error FAILED [  5%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_logs_metrics_on_success FAILED [  6%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_respects_max_retries_from_config PASSED [  7%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_retries_on_failure_then_succeeds PASSED [  8%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_returns_empty_on_max_retries_exceeded PASSED [ 10%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_strips_whitespace_from_response PASSED [ 11%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_successful_generation_on_first_attempt PASSED [ 12%]
tests/test_ai_helpers.py::TestGenerateWithRetry::test_uses_correct_model_name PASSED [ 13%]
tests/test_ai_helpers.py::TestGenerateWithRetryEdgeCases::test_empty_response_text PASSED [ 15%]
tests/test_ai_helpers.py::TestGenerateWithRetryEdgeCases::test_only_whitespace_response PASSED [ 16%]
tests/test_config_loader.py::TestConfigLoader::test_get_config_path_no_traversal PASSED [ 17%]
tests/test_config_loader.py::TestConfigLoader::test_get_config_path_returns_absolute_path FAILED [ 18%]
tests/test_config_loader.py::TestConfigLoader::test_get_config_path_with_different_filenames FAILED [ 20%]
tests/test_config_loader.py::TestConfigLoader::test_load_yaml_file_not_found PASSED [ 21%]
tests/test_config_loader.py::TestConfigLoader::test_load_yaml_with_empty_file PASSED [ 22%]
tests/test_config_loader.py::TestConfigLoader::test_load_yaml_with_valid_content PASSED [ 23%]
tests/test_config_loader.py::TestConfigLoaderIntegration::test_load_accounts_returns_account_list FAILED [ 25%]
tests/test_config_loader.py::TestConfigLoaderIntegration::test_load_generation_policy_structure PASSED [ 26%]
tests/test_config_loader.py::TestConfigLoaderIntegration::test_load_secrets_contains_required_keys PASSED [ 27%]
tests/test_config_loader.py::TestConfigLoaderIntegration::test_load_themes_returns_theme_dict PASSED [ 28%]
tests/test_di_container.py::TestDependencyInversion::test_ai_client_caching PASSED [ 30%]
tests/test_di_container.py::TestDependencyInversion::test_ai_client_provider_abstraction PASSED [ 31%]
tests/test_di_container.py::TestDependencyInversion::test_config_caching PASSED [ 32%]
tests/test_di_container.py::TestDependencyInversion::test_config_provider_abstraction PASSED [ 33%]
tests/test_di_container.py::TestDependencyInversion::test_custom_container_injection PASSED [ 35%]
tests/test_di_container.py::TestDependencyInversion::test_di_container_convenience_methods PASSED [ 36%]
tests/test_di_container.py::TestDependencyInversion::test_di_container_factory PASSED [ 37%]
tests/test_di_container.py::TestDependencyInversion::test_global_container_singleton PASSED [ 38%]
tests/test_di_container.py::TestDIPPatternUsage::test_generator_with_injected_dependencies PASSED [ 40%]
tests/test_html_generator.py::TestRandomFilename::test_custom_length PASSED [ 41%]
tests/test_html_generator.py::TestRandomFilename::test_default_length_is_six PASSED [ 42%]
tests/test_html_generator.py::TestRandomFilename::test_filename_contains_only_alphanumeric PASSED [ 43%]
tests/test_html_generator.py::TestRandomFilename::test_filename_uniqueness PASSED [ 45%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_creates_html_file PASSED [ 46%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_html_contains_og_tags PASSED [ 47%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_html_contains_redirect_url PASSED [ 48%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_html_contains_twitter_tags PASSED [ 50%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_html_escapes_special_characters FAILED [ 51%]
tests/test_html_generator.py::TestCreateRedirectHtml::test_html_has_valid_structure PASSED [ 52%]
tests/test_html_generator.py::TestGenerateShortUrl::test_creates_redirect_html_file PASSED [ 53%]
tests/test_html_generator.py::TestGenerateShortUrl::test_generates_short_url_with_correct_format FAILED [ 55%]
tests/test_html_generator.py::TestGenerateShortUrl::test_product_name_in_html PASSED [ 56%]
tests/test_html_generator.py::TestGenerateShortUrl::test_short_url_uniqueness PASSED [ 57%]
tests/test_logging_provider.py::TestLoggingProvider::test_default_logger_provider_creation PASSED [ 58%]
tests/test_logging_provider.py::TestLoggingProvider::test_get_logger_caches_loggers PASSED [ 60%]
tests/test_logging_provider.py::TestLoggingProvider::test_get_logger_creates_different_loggers PASSED [ 61%]
tests/test_logging_provider.py::TestLoggingProvider::test_get_logger_returns_logger_instance PASSED [ 62%]
tests/test_logging_provider.py::TestLoggingProvider::test_global_logger_provider_singleton PASSED [ 63%]
tests/test_logging_provider.py::TestLoggingProvider::test_logger_has_handlers PASSED [ 65%]
tests/test_logging_provider.py::TestLoggingProvider::test_logger_level_configuration PASSED [ 66%]
tests/test_logging_provider.py::TestLoggingProvider::test_multiple_loggers_independent PASSED [ 67%]
tests/test_logging_provider.py::TestLoggingProvider::test_set_logger_provider PASSED [ 68%]
tests/test_logging_provider.py::TestLoggingProvider::test_setup_file_logging PASSED [ 70%]
tests/test_modules.py::TestConfigLoaderIntegration::test_load_accounts PASSED [ 71%]
tests/test_modules.py::TestConfigLoaderIntegration::test_load_generation_policy PASSED [ 72%]
tests/test_modules.py::TestConfigLoaderIntegration::test_load_secrets PASSED [ 73%]
tests/test_modules.py::TestConfigLoaderIntegration::test_load_themes PASSED [ 75%]
tests/test_modules.py::TestHtmlGenerator::test_create_redirect_html PASSED [ 76%]
tests/test_modules.py::TestHtmlGenerator::test_generate_short_url PASSED [ 77%]
tests/test_modules.py::TestHtmlGenerator::test_random_filename_length PASSED [ 78%]
tests/test_modules.py::TestRetryHelper::test_calculate_backoff PASSED    [ 80%]
tests/test_modules.py::TestRetryHelper::test_metrics_log PASSED          [ 81%]
tests/test_modules.py::TestRetryHelper::test_should_retry_on_error PASSED [ 82%]
tests/test_modules.py::TestAiHelpers::test_create_ai_client PASSED       [ 83%]
tests/test_modules.py::TestAiHelpers::test_generate_with_retry PASSED    [ 85%]
tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_increases_exponentially FAILED [ 86%]
tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_rate_limit_multiplier FAILED [ 87%]
tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_respects_max_limit FAILED [ 88%]
tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_with_jitter FAILED [ 90%]
tests/test_retry_helper.py::TestShouldRetryOnError::test_network_error_is_retryable FAILED [ 91%]
tests/test_retry_helper.py::TestShouldRetryOnError::test_permanent_error_not_retryable PASSED [ 92%]
tests/test_retry_helper.py::TestShouldRetryOnError::test_rate_limit_error_is_retryable PASSED [ 93%]
tests/test_retry_helper.py::TestMetricsLog::test_metrics_log_handles_write_errors_gracefully PASSED [ 95%]
tests/test_retry_helper.py::TestMetricsLog::test_metrics_log_with_none_info FAILED [ 96%]
tests/test_retry_helper.py::TestMetricsLog::test_metrics_log_writes_json_entry FAILED [ 97%]
tests/test_retry_helper.py::TestLogRetryAttempt::test_log_retry_attempt_calls_metrics_log FAILED [ 98%]
tests/test_retry_helper.py::TestLogRetryAttempt::test_log_retry_attempt_with_rate_limit FAILED [100%]

================================== FAILURES ===================================
______________ TestGenerateWithRetry.test_logs_metrics_on_error _______________
tests\test_ai_helpers.py:134: in test_logs_metrics_on_error
    self.assertTrue(mock_metrics_log.called)
E   AssertionError: False is not true
---------------------------- Captured stdout call -----------------------------

[!] AI呼び出し失敗 (試行 1/3)
--- エラー詳細 ---
Test error
再試行まで待機: 3.8s（バックオフ: 2.0s, 試行: 1/3）

[!] AI呼び出し失敗 (試行 2/3)
--- エラー詳細 ---
Test error
再試行まで待機: 5.0s（バックオフ: 4.0s, 試行: 2/3）
[!] 最大リトライ到達。空の結果を返します。
_____________ TestGenerateWithRetry.test_logs_metrics_on_success ______________
tests\test_ai_helpers.py:123: in test_logs_metrics_on_success
    self.assertTrue(mock_metrics_log.called)
E   AssertionError: False is not true
_________ TestConfigLoader.test_get_config_path_returns_absolute_path _________
tests\test_config_loader.py:23: in test_get_config_path_returns_absolute_path
    self.assertTrue(result.endswith("config/test_file.yaml"))
E   AssertionError: False is not true
_______ TestConfigLoader.test_get_config_path_with_different_filenames ________
tests\test_config_loader.py:30: in test_get_config_path_with_different_filenames
    self.assertTrue(result.endswith(f"config/{filename}"))
E   AssertionError: False is not true
_____ TestConfigLoaderIntegration.test_load_accounts_returns_account_list _____
tests\test_config_loader.py:100: in test_load_accounts_returns_account_list
    self.assertIsInstance(accounts, list)
E   AssertionError: {'ぴょん': {'genres': {'総合': 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20170404?keyword=%E4%BA%88%E7%B4%84&booksGenreId=000&availability=5&sort=sales&hits=5', 'CD': 'https://app.rakuten.co.jp/services/api/BooksCD/Search/20170404?title=%E9%99%90%E5%AE%9A&booksGenreId=002&availability=5&sort=sales&hits=5', 'ゲーム': 'https://app.rakuten.co.jp/services/api/BooksGame/Search/20170404?title=%E7%89%B9%E5%85%B8&booksGenreId=006&availability=5&sort=sales&hits=5'}, 'themes': ['日常の気づき', '生活習慣', '季節', '健康・美容', '子育て・教育', 'ファッション'], 'affiliate': {'template': 'normal'}}, 'ツイてる': {'genres': {'DVD': 'https://app.rakuten.co.jp/services/api/BooksDVD/Search/20170404?booksGenreId=003&sort=standard&availability=5&limitedFlag=1&hits=5', '雑誌': 'https://app.rakuten.co.jp/services/api/BooksMagazine/Search/20170404?booksGenreId=007604001&sort=sales&availability=5&hits=5', 'ゲーム': 'https://app.rakuten.co.jp/services/api/BooksGame/Search/20170404?title=%E7%89%B9%E5%85%B8&booksGenreId=006&availability=5&sort=sales&hits=5'}, 'themes': ['AI豆知識', 'お金の小ネタ', '趣味', 'ライフハック', 'IT・テクノロジー', 'お金・節約術'], 'affiliate': {'template': 'normal'}}, 'さくら': {'genres': {'総合ランキング': 'https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628?genreId=0&hits=5', '美容コスメ': 'https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628?genreId=100371&hits=5', 'スイーツ': 'https://app.rakuten.co.jp/services/api/IchibaItem/Ranking/20170628?genreId=551167&hits=5'}, 'themes': ['名言と一言', 'ユーモア', 'グルメ・レシピ', '旅行・観光スポット', '前向きメッセージ', 'プチ贅沢', '癒しのひととき'], 'affiliate': {'template': 'sakura'}}} is not an instance of <class 'list'>
_________ TestCreateRedirectHtml.test_html_escapes_special_characters _________
tests\test_html_generator.py:148: in test_html_escapes_special_characters
    self.assertNotIn('<script>', content)
E   AssertionError: '<script>' unexpectedly found in '<!DOCTYPE html>\n<html lang="ja">\n  <head>\n    <meta charset="utf-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1">\n    <title>Product &lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;</title>\n    <meta property="og:title" content="Product &lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;">\n    <meta property="og:description" content="楽天 - Product &lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;">\n    <meta property="og:image" content="">\n    <meta property="og:type" content="product">\n    <meta property="og:url" content="https://example.com">\n    <meta name="twitter:card" content="summary_large_image">\n    <meta name="twitter:title" content="Product &lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;">\n    <meta name="twitter:description" content="楽天 - Product &lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;">\n    <meta name="twitter:image" content="">\n    <script>\n      window.location.replace("https://example.com");\n    </script>\n  </head>\n  <body></body>\n</html>\n'
______ TestGenerateShortUrl.test_generates_short_url_with_correct_format ______
tests\test_html_generator.py:197: in test_generates_short_url_with_correct_format
    self.assertTrue(short_url.startswith("https://example.com/rktn"))
E   AssertionError: False is not true
__________ TestCalculateBackoff.test_backoff_increases_exponentially __________
tests\test_retry_helper.py:26: in test_backoff_increases_exponentially
    result1 = calculate_backoff(1, base, 120)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\retry_helper.py:60: in calculate_backoff
    base = config.get("retry_base_backoff", 2.0)
           ^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'get'
___________ TestCalculateBackoff.test_backoff_rate_limit_multiplier ___________
tests\test_retry_helper.py:43: in test_backoff_rate_limit_multiplier
    without_multiplier = calculate_backoff(1, 2.0, 120, rate_limit_multiplier=1)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: calculate_backoff() got an unexpected keyword argument 'rate_limit_multiplier'
____________ TestCalculateBackoff.test_backoff_respects_max_limit _____________
tests\test_retry_helper.py:38: in test_backoff_respects_max_limit
    result = calculate_backoff(10, 2.0, max_backoff)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\retry_helper.py:60: in calculate_backoff
    base = config.get("retry_base_backoff", 2.0)
           ^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'get'
________________ TestCalculateBackoff.test_backoff_with_jitter ________________
tests\test_retry_helper.py:56: in test_backoff_with_jitter
    results = [calculate_backoff(attempt, base, max_backoff) for _ in range(5)]
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src\retry_helper.py:60: in calculate_backoff
    base = config.get("retry_base_backoff", 2.0)
           ^^^^^^^^^^
E   AttributeError: 'int' object has no attribute 'get'
___________ TestShouldRetryOnError.test_network_error_is_retryable ____________
tests\test_retry_helper.py:104: in test_network_error_is_retryable
    self.assertTrue(result, f"Should retry on: {error_msg}")
E   AssertionError: False is not true : Should retry on: Connection timeout
_______________ TestMetricsLog.test_metrics_log_with_none_info ________________
tests\test_retry_helper.py:138: in test_metrics_log_with_none_info
    parsed = json.loads(written_data)
             ^^^^
E   NameError: name 'json' is not defined. Did you forget to import 'json'
______________ TestMetricsLog.test_metrics_log_writes_json_entry ______________
tests\test_retry_helper.py:125: in test_metrics_log_writes_json_entry
    parsed = json.loads(written_data)
             ^^^^
E   NameError: name 'json' is not defined. Did you forget to import 'json'
________ TestLogRetryAttempt.test_log_retry_attempt_calls_metrics_log _________
tests\test_retry_helper.py:159: in test_log_retry_attempt_calls_metrics_log
    log_retry_attempt(
    ^^^^^^^^^^^^^^^^^
E   NameError: name 'log_retry_attempt' is not defined
_________ TestLogRetryAttempt.test_log_retry_attempt_with_rate_limit __________
tests\test_retry_helper.py:173: in test_log_retry_attempt_with_rate_limit
    log_retry_attempt(
    ^^^^^^^^^^^^^^^^^
E   NameError: name 'log_retry_attempt' is not defined
=========================== short test summary info ===========================
FAILED tests/test_ai_helpers.py::TestGenerateWithRetry::test_logs_metrics_on_error
FAILED tests/test_ai_helpers.py::TestGenerateWithRetry::test_logs_metrics_on_success
FAILED tests/test_config_loader.py::TestConfigLoader::test_get_config_path_returns_absolute_path
FAILED tests/test_config_loader.py::TestConfigLoader::test_get_config_path_with_different_filenames
FAILED tests/test_config_loader.py::TestConfigLoaderIntegration::test_load_accounts_returns_account_list
FAILED tests/test_html_generator.py::TestCreateRedirectHtml::test_html_escapes_special_characters
FAILED tests/test_html_generator.py::TestGenerateShortUrl::test_generates_short_url_with_correct_format
FAILED tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_increases_exponentially
FAILED tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_rate_limit_multiplier
FAILED tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_respects_max_limit
FAILED tests/test_retry_helper.py::TestCalculateBackoff::test_backoff_with_jitter
FAILED tests/test_retry_helper.py::TestShouldRetryOnError::test_network_error_is_retryable
FAILED tests/test_retry_helper.py::TestMetricsLog::test_metrics_log_with_none_info
FAILED tests/test_retry_helper.py::TestMetricsLog::test_metrics_log_writes_json_entry
FAILED tests/test_retry_helper.py::TestLogRetryAttempt::test_log_retry_attempt_calls_metrics_log
FAILED tests/test_retry_helper.py::TestLogRetryAttempt::test_log_retry_attempt_with_rate_limit
======================== 16 failed, 64 passed in 4.46s ========================
