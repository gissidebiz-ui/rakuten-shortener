name: Pipeline Integration Test

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'config/**'
      - '.github/workflows/validate-pipeline.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'config/**'

jobs:
  pipeline-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install google-generativeai pyyaml requests

    - name: Create config files (mock for testing)
      run: |
        mkdir -p config
        # Note: Actual secrets need to be set via GitHub Secrets in production
        echo "accounts:" > config/accounts.yaml
        echo "  test_account:" >> config/accounts.yaml
        echo "    username: test_user" >> config/accounts.yaml
        echo "    password: test_pass" >> config/accounts.yaml

    - name: Create data directories
      run: |
        mkdir -p data/input
        mkdir -p data/output

    - name: Verify Python syntax
      run: |
        python -m py_compile src/run_all.py src/make_input_csv.py src/normal_post_generator.py src/affiliate_post_generator.py src/merge_posts.py

    - name: Test imports (without execution)
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from di_container import get_container, DIContainer
        from config_loader import load_yaml, load_generation_policy
        from retry_helper import metrics_log
        from ai_helpers import create_ai_client
        from html_generator import random_filename
        print('✓ All imports successful')
        "

    - name: Validate pipeline modules structure
      run: |
        python -c "
        import os
        import sys
        sys.path.insert(0, 'src')
        
        modules = [
            'src/config_loader.py',
            'src/retry_helper.py',
            'src/ai_helpers.py',
            'src/html_generator.py',
            'src/di_container.py',
            'src/normal_post_generator.py',
            'src/affiliate_post_generator.py'
        ]
        
        for module in modules:
            if not os.path.exists(module):
                raise FileNotFoundError(f'Missing module: {module}')
        
        print(f'✓ All {len(modules)} core modules present')
        "

    - name: Check DI container configuration
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from di_container import DIContainer, DefaultConfigProvider, DefaultAIClientProvider
        
        # Test container instantiation
        container = DIContainer(
            config_provider=DefaultConfigProvider(),
            ai_client_provider=DefaultAIClientProvider()
        )
        print('✓ DI container instantiation successful')
        "
      continue-on-error: true

    - name: Summary
      if: always()
      run: |
        echo "=== Pipeline Integration Test Summary ==="
        echo "✓ All modules verified"
        echo "✓ Import structure validated"
        echo "✓ DI container configuration tested"
